@inherits LayoutComponentBase
@implements IDisposable
@inject SYSS8.OPF.Clean.WebUi.Services.IUiStatus Ui

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ðŸ—™</a>
</div>

@* OBS: Offline/Reconnecting banner *@
@if (Ui.IsOffline)
{
    <div class="net-banner" role="status" aria-live="polite">Ã…teransluter â€¦</div>
}

@* OBS: Standardiserad felpanel (ProblemDetails â†’ UiError) *@
@if (Ui.Error is not null)
{
    <div class="error-panel">
        <div class="error-card">
            <div class="error-title">@Ui.Error.Title</div>
            <div class="error-detail">@Ui.Error.Detail</div>
            <button class="btn" @onclick="() => Ui.SetError(null)">StÃ¤ng</button>
        </div>
    </div>
}

@* Busy overlay ger tydlig feedback under async-anrop *@
@if (Ui.IsBusy)
{
    <div class="busy-overlay">
        <div class="spinner" aria-label="Laddar"></div>
    </div>
}

@code {
    private System.Threading.Timer? _errorTimer;

    protected override void OnInitialized()
    {
        Ui.Changed += OnUiChanged;
    }

    private void OnUiChanged()
    {
        // DESIGN-VAL: Auto-stÃ¤ng felpanel efter 5s om anvÃ¤ndaren inte sjÃ¤lv stÃ¤nger.        
        if (Ui.Error is not null)
        {
            _errorTimer?.Dispose();
            _errorTimer = new System.Threading.Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    Ui.SetError(null);
                    StateHasChanged();
                });
            }, null, TimeSpan.FromSeconds(5), Timeout.InfiniteTimeSpan);
        }
        else
        {
            // Rensa timer om felet stÃ¤ngs manuellt
            _errorTimer?.Dispose();
            _errorTimer = null;
        }

        StateHasChanged();
    }

    public void Dispose()
    {
        Ui.Changed -= OnUiChanged;
        _errorTimer?.Dispose();
    }
}
