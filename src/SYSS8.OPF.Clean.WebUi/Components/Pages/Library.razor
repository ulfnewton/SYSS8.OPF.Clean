@page "/library"
@namespace SYSS8.OPF.Clean.WebUi.Components.Pages
@using SYSS8.OPF.Clean.WebApi.Contracts
@inject ApiClient Api
@inject AuthState Auth
@inject IUiStatus UI
@using SYSS8.OPF.Clean.WebUi.Components.Shared

<h3>Authors</h3>

@if (!Auth.IsAuthenticated)
{
        <p>Inte inloggad. <a href="/">Logga in</a>.</p>
}
else
{
    <p>Inloggad som <b>@Auth.PreferredNamed</b> (@Auth.Role)</p>
    <button @onclick="Load">Ladda lista</button>

    <RoleGate Roles="@(new[] {"Lärare", "Admin"})">
        <div class="mt-3">
            <h4>Skapa author (endast lärare/admin)</h4>
            <input @bind="_create.Name" placeholder="Namn" />
            <button @onclick="Create" disabled="@string.IsNullOrWhiteSpace(_create.Name)">Skapa</button>
        </div>
    </RoleGate>

    @if (_authors is null)
    {
        <p><em>Ingen data ännu.</em></p>
    }
    else if (_authors.Count == 0)
    {
        <p>Tomt.</p>
    }
    else
    {
        <ul>
            @foreach(var author in _authors)
            {
                <li>@author.Name</li>
            }
        </ul>
    }
}

@code {
    List<AuthorDTO> _authors = [];
    CreateAuthorDTO _create = new();

    async Task Load()
    {
        try
        {
            UI.Busy(true);
            await Api.CreateAuthorAsync(_create.Name);
            _authors = await Api.GetAuthorAsync();
        }
        catch(ApiProblemException ex) when (ex.Status == StatusCodes.Status401Unauthorized)
        {
            UI.SetError(new UiError("Ej inloggad", "Logga in för att skapa author."));
        }
        catch (ApiProblemException ex) when (ex.Status == StatusCodes.Status403Forbidden)
        {
            UI.SetError(new UiError("Behörighet saknas", "Denna åtgärd kräver lärare eller admin behörighet."));
        }
        catch (ApiProblemException) 
        {
            UI.SetError(new UiError("Fel", "Denna åtgärd kräver lärare eller admin behörighet."));
        }
        finally
        {
            UI.Busy(false);
        }
    }

    async Task Create()
    {
        try
        {
            UI.Busy(true);
            await Api.CreateAuthorAsync(_create.Name);
            _create = new();
            await Load();
        }
        catch(ApiProblemException ex)
        {
            UI.SetError(new UiError("Fel", ex.Message));
        }
        finally
        {
            UI.Busy(false);
        }
    }

    public class CreateAuthorDTO
    {
        public string Name { get; set; }
    }
}
