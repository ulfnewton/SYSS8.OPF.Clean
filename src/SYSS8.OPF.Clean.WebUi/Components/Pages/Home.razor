
@page "/"
@inject ApiClient Api
@inject ITokenStore Tokens
@inject AuthState Auth
@inject NavigationManager Nav
@inject IUiStatus UI

<PageTitle>Sign in</PageTitle>

<h1 class="h3 mb-4">Sign in</h1>

<EditForm Model="_input" OnValidSubmit="Login">
    <div class="row g-3">
        <div class="col-12 col-md-6">
            <label for="email" class="form-label">Email</label>
            <InputText id="email" @bind-Value="_input.Email" class="form-control" />
        </div>
        <div class="col-12 col-md-6">
            <label for="pwd" class="form-label">Password</label>
            <InputText id="pwd" type="password" @bind-Value="_input.Password" class="form-control" />
        </div>
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Sign in</button>
            <span class="text-body-secondary small">
                Demo accounts: admin/teacher/student@example.com (Password1!)
            </span>
        </div>
    </div>
</EditForm>

@code {
    Input _input = new() { Email = "teacher@example.com", Password = "Password1!" };

    async Task Login()
    {
        try
        {
            UI.Busy(true);
            var res = await Api.LoginAsync(_input.Email, _input.Password);
            Tokens.SetToken(res.Token);
            Auth.SignIn(role: res.Role, preferredName: res.Email ?? "");
            Nav.NavigateTo("/library");
        }
        catch (ApiProblemException ex)
        {
            UI.SetError(new UiError("Sign-in failed", ex.Message));
        }
        finally
        {
            UI.Busy(false);
        }
    }
    public class Input { public string Email { get; set; } = ""; public string Password { get; set; } = ""; }
}
