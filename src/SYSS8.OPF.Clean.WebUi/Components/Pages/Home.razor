@page "/"
@inject AuthState Auth 
@inject NavigationManager Navigation
@inject IUiStatus UI
@inject ApiClient Api
@inject ITokenStore Tokens

<PageTitle>Home</PageTitle>

<h1>Oautentiserad vy - logga in nedan</h1>

<EditForm Model="input" OnValidSubmit="Login" FormName="login">
    <label>Roll</label>
    <InputSelect @bind-Value="input.Role">
        <option value="Student">Student</option>
        <option value="Lärare">Lärare</option>
        <option value="Admin">Admin</option>
    </InputSelect>
    <div class="mb-2">
        <label>Namn</label>
        <InputText @bind-Value="input.Name" />
    </div>
    <div class="mb-2">
        <label>Lösenord</label>
        <InputText @bind-Value="input.Password" type="password" />
    </div>
    <button>Logga in</button>
</EditForm>

<p class="mt-3">
    <em>Demo-konton:</em> <code>admin@example.com</code>, <code>teacher@example.com</code>, 
    <code>student@example.com</code> (lösen: <code>Pass123!</code>)
</p>

@code {
    Input input = new();

    async Task Login()
    {
        UI.Busy(true);

        try
        {
            var res = await Api.LoginAsync(input.Name, input.Password);
            Tokens.SetToken(res.Token);
            Auth.SignIn(input.Role, input.Name);
            Navigation.NavigateTo("/library");
        }
        catch(ApiProblemException ex)
        {
            UI.SetError(new UiError("Inloggningen misslyckades", ex.Message));
        }
        finally
        {
            UI.Busy(false);
        }
    }

    // [Inject] AuthState State { get; set; }
    public class Input
    {
        public string Role { get; set; } = "Lärare";
        public string Name { get; set; } = "teacher@example.com";
        public string Password { get; set; } = "Pass123!";
    }
}
